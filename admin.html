<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panel - Blocksense Community Calls</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <!-- Hard-looking font for the whole app -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <!-- Styles -->
    <link rel="stylesheet" href="light.css"/>
    <style>
        /* Admin Panel Specific Styles */
        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-family: 'Oswald', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .admin-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 18px var(--shadow-color);
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .admin-header p {
            font-size: 1.1rem;
            color: var(--update-item-content-color);
            margin: 0;
        }
        
        .admin-form {
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 30px;
            box-shadow: 0 6px 18px var(--shadow-color);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Oswald', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--link-bg);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px dashed var(--border-color);
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
        }
        
        .file-input-label:hover {
            border-color: var(--link-bg);
            background: rgba(49, 130, 206, 0.05);
        }
        
        .file-input-label.has-file {
            border-style: solid;
            border-color: var(--highlight-success);
            background: rgba(72, 187, 120, 0.1);
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--link-bg), var(--link-hover-bg));
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Oswald', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(49, 130, 206, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        
        .status-success {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--highlight-success);
            color: var(--highlight-success);
        }
        
        .status-error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid #e53e3e;
            color: #e53e3e;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--container-bg);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            background: var(--link-bg);
            color: white;
            transform: translateY(-1px);
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            
            .admin-header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .admin-form {
                padding: 20px;
            }
            
            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }
        
        /* Access Denied Styles */
        .access-denied {
            text-align: center;
            padding: 60px 20px;
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 18px var(--shadow-color);
        }
        
        .access-denied h1 {
            color: #e53e3e;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .access-denied p {
            color: var(--update-item-content-color);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .access-denied .back-link {
            margin-bottom: 0;
        }
        
        /* Mode Selection Styles */
        .mode-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Oswald', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mode-btn:hover {
            border-color: var(--link-bg);
            background: rgba(49, 130, 206, 0.1);
        }
        
        .mode-btn.active {
            background: var(--link-bg);
            color: white;
            border-color: var(--link-bg);
        }
        
        /* Call List Styles */
        .call-list-section {
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 6px 18px var(--shadow-color);
        }
        
        .call-list-section h3 {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .call-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .call-item {
            background: var(--stat-card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .call-item:hover {
            border-color: var(--link-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .call-item.selected {
            border-color: var(--link-bg);
            background: rgba(49, 130, 206, 0.1);
        }
        
        .call-item h4 {
            margin: 0 0 8px 0;
            color: var(--header-color);
            font-size: 1.1rem;
        }
        
        .call-item p {
            margin: 0;
            color: var(--update-item-content-color);
            font-size: 0.9rem;
        }
        
        .call-item .call-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .call-item .call-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .call-item .edit-action {
            background: var(--highlight-info);
            color: white;
        }
        
        .call-item .delete-action {
            background: #e53e3e;
            color: white;
        }
        
        .call-item .call-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Form Buttons */
        .form-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .submit-btn.edit-btn {
            background: linear-gradient(135deg, var(--highlight-success), #38a169);
        }
        
        .submit-btn.cancel-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }
        
        /* Delete Confirmation Modal */
        .delete-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .delete-modal-content {
            background: var(--container-bg);
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 12px 32px var(--shadow-color);
        }
        
        .delete-modal h3 {
            color: #e53e3e;
            margin-bottom: 15px;
        }
        
        .delete-modal p {
            color: var(--update-item-content-color);
            margin-bottom: 25px;
        }
        
        .delete-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .delete-modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-confirm {
            background: #e53e3e;
            color: white;
        }
        
        .delete-cancel {
            background: var(--pagination-btn-bg);
            color: var(--text-color);
        }
        
        .delete-modal-buttons button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h1><i class="fas fa-lock"></i> Access Denied</h1>
            <p>You don't have permission to access this admin panel. Please check the URL parameters.</p>
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Main Site
            </a>
        </div>
        
        <div id="adminPanel">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Main Site
            </a>
            
            <div class="admin-header">
                <h1>
                    <i class="fas fa-user-shield"></i>
                    Admin Panel
                </h1>
                <p>Manage Community Calls and Transcripts</p>
            </div>
            
            <!-- Mode Selection -->
            <div class="mode-selection">
                <button type="button" id="addModeBtn" class="mode-btn active">
                    <i class="fas fa-plus"></i> Add New Call
                </button>
                <button type="button" id="editModeBtn" class="mode-btn">
                    <i class="fas fa-edit"></i> Edit Call
                </button>
                <button type="button" id="deleteModeBtn" class="mode-btn">
                    <i class="fas fa-trash"></i> Delete Call
                </button>
            </div>
            
            <!-- Call List for Edit/Delete -->
            <div id="callListSection" class="call-list-section" style="display: none;">
                <h3><i class="fas fa-list"></i> Existing Calls</h3>
                <div id="callList" class="call-list">
                    <!-- Call list will be populated here -->
                </div>
            </div>
            
            <form id="adminForm" class="admin-form">
                <div class="form-group">
                    <label for="callNumber">
                        <i class="fas fa-hashtag"></i>
                        Call Number
                    </label>
                    <input type="number" id="callNumber" name="callNumber" min="1" max="999" required>
                </div>
                
                <div class="form-group">
                    <label for="callDate">
                        <i class="fas fa-calendar"></i>
                        Date
                    </label>
                    <input type="text" id="callDate" name="callDate" placeholder="e.g., 15 December 2024" required>
                </div>
                
                <div class="form-group">
                    <label for="youtubeLink">
                        <i class="fab fa-youtube"></i>
                        YouTube Link
                    </label>
                    <input type="url" id="youtubeLink" name="youtubeLink" placeholder="https://www.youtube.com/watch?v=..." required>
                    <small style="color: var(--update-item-content-color); margin-top: 5px; display: block;">
                        Enter the full YouTube URL. It will be automatically converted to embed format.
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="englishTranscript">
                        <i class="fas fa-file-alt"></i>
                        English Transcript
                    </label>
                    <div class="file-input-wrapper">
                        <input type="file" id="englishTranscript" name="englishTranscript" class="file-input" accept=".txt" required>
                        <label for="englishTranscript" class="file-input-label">
                            <i class="fas fa-upload"></i>
                            <span class="file-label-text">Choose English transcript file (.txt)</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="turkishTranscript">
                        <i class="fas fa-file-alt"></i>
                        Turkish Transcript
                    </label>
                    <div class="file-input-wrapper">
                        <input type="file" id="turkishTranscript" name="turkishTranscript" class="file-input" accept=".txt" required>
                        <label for="turkishTranscript" class="file-input-label">
                            <i class="fas fa-upload"></i>
                            <span class="file-label-text">Choose Turkish transcript file (.txt)</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <i class="fas fa-plus"></i>
                        Add New Call
                        <div class="loading-spinner" id="loadingSpinner"></div>
                    </button>
                    <button type="button" class="submit-btn edit-btn" id="updateBtn" style="display: none;">
                        <i class="fas fa-save"></i>
                        Update Call
                        <div class="loading-spinner" id="updateSpinner"></div>
                    </button>
                    <button type="button" class="submit-btn cancel-btn" id="cancelBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Delete Community Call</h3>
            <p id="deleteMessage">Are you sure you want to delete this community call? This action cannot be undone.</p>
            <div class="delete-modal-buttons">
                <button class="delete-confirm" id="deleteConfirmBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="delete-cancel" id="deleteCancelBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Check for secret parameter
        const urlParams = new URLSearchParams(window.location.search);
        const secret = urlParams.get('secret');
        
        if (secret !== 'antoncehov1890!?') {
            document.getElementById('accessDenied').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        } else {
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        // File input handling
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', function() {
                const label = this.nextElementSibling;
                const labelText = label.querySelector('.file-label-text');
                
                if (this.files.length > 0) {
                    label.classList.add('has-file');
                    labelText.textContent = `Selected: ${this.files[0].name}`;
                } else {
                    label.classList.remove('has-file');
                    labelText.textContent = labelText.getAttribute('data-original-text') || 'Choose file';
                }
            });
        });
        
        // Store original text for file labels
        document.querySelectorAll('.file-label-text').forEach(text => {
            text.setAttribute('data-original-text', text.textContent);
        });
        
        // Global variables
        let currentMode = 'add';
        let editingCallNumber = null;
        let deletingCallNumber = null;
        let existingCalls = [];
        
        // Mode selection handlers
        document.getElementById('addModeBtn').addEventListener('click', () => switchMode('add'));
        document.getElementById('editModeBtn').addEventListener('click', () => switchMode('edit'));
        document.getElementById('deleteModeBtn').addEventListener('click', () => switchMode('delete'));
        
        // Cancel button handler
        document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
        
        // Delete modal handlers
        document.getElementById('deleteCancelBtn').addEventListener('click', closeDeleteModal);
        document.getElementById('deleteConfirmBtn').addEventListener('click', confirmDelete);
        
        // Load existing calls on page load
        loadExistingCalls();
        
        // Switch between modes
        function switchMode(mode) {
            currentMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            // Show/hide sections
            const callListSection = document.getElementById('callListSection');
            const form = document.getElementById('adminForm');
            
            if (mode === 'add') {
                callListSection.style.display = 'none';
                form.style.display = 'block';
                resetForm();
                showAddButton();
            } else if (mode === 'edit') {
                callListSection.style.display = 'block';
                form.style.display = 'block';
                showEditButtons();
            } else if (mode === 'delete') {
                callListSection.style.display = 'block';
                form.style.display = 'none';
            }
        }
        
        // Load existing calls
        async function loadExistingCalls() {
            try {
                const response = await fetch('/api/admin/get-calls');
                if (response.ok) {
                    existingCalls = await response.json();
                    displayCalls();
                } else {
                    // Fallback: parse from script.js content
                    existingCalls = parseCallsFromScript();
                    displayCalls();
                }
            } catch (error) {
                console.error('Error loading calls:', error);
                existingCalls = parseCallsFromScript();
                displayCalls();
            }
        }
        
        // Parse calls from script.js content (fallback)
        function parseCallsFromScript() {
            // This is a fallback method - in real implementation, this would be handled by backend
            const callDates = [
                "12 August 2024", "8 November 2024", "7 December 2024", "11 January 2025",
                "6 February 2025", "7 March 2025", "3 April 2025", "5 May 2025",
                "30 May 2025", "2 July 2025", "31 July 2025", "5 September 2025"
            ];
            
            return callDates.map((date, index) => ({
                callNumber: index + 1,
                callDate: date,
                youtubeLink: `https://www.youtube.com/embed/VIDEO_${index + 1}`,
                hasTranscript: true
            }));
        }
        
        // Display calls in the list
        function displayCalls() {
            const callList = document.getElementById('callList');
            callList.innerHTML = '';
            
            existingCalls.forEach(call => {
                const callItem = document.createElement('div');
                callItem.className = 'call-item';
                callItem.innerHTML = `
                    <h4>Community Call ${call.callNumber}</h4>
                    <p>${call.callDate}</p>
                    <div class="call-actions">
                        <button class="edit-action" onclick="selectCallForEdit(${call.callNumber})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-action" onclick="selectCallForDelete(${call.callNumber})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                callList.appendChild(callItem);
            });
        }
        
        // Select call for editing
        function selectCallForEdit(callNumber) {
            const call = existingCalls.find(c => c.callNumber === callNumber);
            if (!call) return;
            
            editingCallNumber = callNumber;
            
            // Populate form with call data
            document.getElementById('callNumber').value = call.callNumber;
            document.getElementById('callDate').value = call.callDate;
            document.getElementById('youtubeLink').value = call.youtubeLink;
            
            // Update file labels to show existing files
            document.querySelectorAll('.file-input-label').forEach(label => {
                label.classList.add('has-file');
                const labelText = label.querySelector('.file-label-text');
                labelText.textContent = 'Existing file (replace if needed)';
            });
            
            // Switch to edit mode
            switchMode('edit');
            showEditButtons();
        }
        
        // Select call for deletion
        function selectCallForDelete(callNumber) {
            deletingCallNumber = callNumber;
            const call = existingCalls.find(c => c.callNumber === callNumber);
            
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete Community Call ${callNumber} (${call.callDate})? This action cannot be undone.`;
            
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        // Show add button
        function showAddButton() {
            document.getElementById('submitBtn').style.display = 'flex';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('submitBtn').innerHTML = `
                <i class="fas fa-plus"></i>
                Add New Call
                <div class="loading-spinner" id="loadingSpinner"></div>
            `;
        }
        
        // Show edit buttons
        function showEditButtons() {
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'flex';
            document.getElementById('cancelBtn').style.display = 'flex';
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('adminForm').reset();
            editingCallNumber = null;
            document.querySelectorAll('.file-input-label').forEach(label => {
                label.classList.remove('has-file');
                const labelText = label.querySelector('.file-label-text');
                labelText.textContent = labelText.getAttribute('data-original-text');
            });
        }
        
        // Cancel edit
        function cancelEdit() {
            resetForm();
            switchMode('add');
        }
        
        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deletingCallNumber = null;
        }
        
        // Confirm delete
        async function confirmDelete() {
            if (!deletingCallNumber) return;
            
            try {
                const response = await fetch('/api/admin/delete-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ callNumber: deletingCallNumber })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatusMessage('success', result.message);
                    
                    // Remove from local list
                    existingCalls = existingCalls.filter(c => c.callNumber !== deletingCallNumber);
                    displayCalls();
                    
                    closeDeleteModal();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Delete failed');
                }
            } catch (error) {
                showStatusMessage('error', `Error: ${error.message}`);
            }
        }
        
        // Show status message
        function showStatusMessage(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Form submission
        document.getElementById('adminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (currentMode === 'edit') {
                await handleUpdateCall();
            } else {
                await handleAddCall();
            }
        });
        
        // Update button handler
        document.getElementById('updateBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            await handleUpdateCall();
        });
        
        // Handle add call
        async function handleAddCall() {
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Show loading state
            submitBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            
            try {
                const adminData = await getFormData();
                const result = await processAdminRequest(adminData);
                
                showStatusMessage('success', 'Call added successfully! All files have been updated and committed to git.');
                
                // Reset form and reload calls
                resetForm();
                await loadExistingCalls();
                
            } catch (error) {
                console.error('Error:', error);
                showStatusMessage('error', `Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Handle update call
        async function handleUpdateCall() {
            const updateBtn = document.getElementById('updateBtn');
            const updateSpinner = document.getElementById('updateSpinner');
            
            // Show loading state
            updateBtn.disabled = true;
            updateSpinner.style.display = 'block';
            
            try {
                const adminData = await getFormData();
                adminData.callNumber = editingCallNumber; // Use existing call number
                
                const result = await processUpdateRequest(adminData);
                
                showStatusMessage('success', 'Call updated successfully! All files have been updated and committed to git.');
                
                // Reset form and reload calls
                resetForm();
                await loadExistingCalls();
                switchMode('add');
                
            } catch (error) {
                console.error('Error:', error);
                showStatusMessage('error', `Error: ${error.message}`);
            } finally {
                updateBtn.disabled = false;
                updateSpinner.style.display = 'none';
            }
        }
        
        // Get form data
        async function getFormData() {
            const form = document.getElementById('adminForm');
            const formData = new FormData(form);
            const callNumber = formData.get('callNumber');
            const callDate = formData.get('callDate');
            const youtubeLink = formData.get('youtubeLink');
            const englishTranscript = formData.get('englishTranscript');
            const turkishTranscript = formData.get('turkishTranscript');
            
            // Validate inputs
            if (!callNumber || !callDate || !youtubeLink) {
                throw new Error('Call number, date, and YouTube link are required');
            }
            
            // For editing, transcripts are optional if no new files are selected
            if (currentMode === 'add' && (!englishTranscript || !turkishTranscript)) {
                throw new Error('Transcript files are required for new calls');
            }
            
            // Convert YouTube URL to embed format
            let embedUrl = youtubeLink;
            if (youtubeLink.includes('youtube.com/watch?v=')) {
                const videoId = youtubeLink.split('v=')[1].split('&')[0];
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            } else if (youtubeLink.includes('youtu.be/')) {
                const videoId = youtubeLink.split('youtu.be/')[1].split('?')[0];
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }
            
            const adminData = {
                callNumber: parseInt(callNumber),
                callDate: callDate,
                youtubeLink: embedUrl
            };
            
            // Add transcript data only if files are selected
            if (englishTranscript && englishTranscript.size > 0) {
                adminData.englishTranscript = {
                    name: englishTranscript.name,
                    content: await readFileAsText(englishTranscript)
                };
            }
            
            if (turkishTranscript && turkishTranscript.size > 0) {
                adminData.turkishTranscript = {
                    name: turkishTranscript.name,
                    content: await readFileAsText(turkishTranscript)
                };
            }
            
            return adminData;
        }
        
        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }
        
        // Process admin request via backend API
        async function processAdminRequest(data) {
            try {
                const response = await fetch('/api/admin/add-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Admin request successful:', result);
                return result;
                
            } catch (error) {
                console.error('Admin API Error:', error);
                throw error;
            }
        }
        
        // Process update request via backend API
        async function processUpdateRequest(data) {
            try {
                const response = await fetch('/api/admin/update-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Update request successful:', result);
                return result;
                
            } catch (error) {
                console.error('Update API Error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
